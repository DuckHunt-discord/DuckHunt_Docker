version: "3.7"

services:
  duckhunt_bot:
    build: https://github.com/DuckHunt-discord/DHV4.git

    container_name: duckhunt_bot
    hostname: duckhunt_bot

    environment:
      BOT_TOKEN: ${BOT_TOKEN}
      GLOBAL_API_KEY: ${GLOBAL_API_KEY}
      DB_HOST: "duckhunt_postgres"
      DB_USER: "duckhunt"
      DB_PASSWORD: "duckhunt"
      DB_NAME: "duckhunt"

    volumes:
      - duckhunt_cache:/bot/cache

    networks:
      - duckhunt

    depends_on:
      - duckhunt_postgres

    restart: unless-stopped

    logging:
      options:
        max-size: "1m"
        max-file: "3"

  duckhunt_website:
    build: https://github.com/DuckHunt-discord/DHV4_Web.git

    container_name: duckhunt_website
    hostname: duckhunt_website

    environment:
      SECRET_KEY: ${SECRET_KEY}
      DH_API_KEY: ${GLOBAL_API_KEY}
      DH_API_URL: "http://duckhunt_bot:8080/api"
      DB_HOST: "duckhunt_postgres"
      DB_USER: "duckhunt"
      DB_PASSWORD: "duckhunt"
      DB_NAME: "duckhunt"
      MEMCACHED_LOC: "duckhunt_cache:11211"

    volumes:
      - web_static:/static:rw

    networks:
      - duckhunt

    depends_on:
      - duckhunt_postgres
      - duckhunt_cache

    restart: unless-stopped

    logging:
      options:
        max-size: "1m"
        max-file: "3"

  duckhunt_proxy:
    image: caddy:2
    container_name: duckhunt_proxy
    hostname: duckhunt_proxy

    ports:
      - "80:80"
      - "443:443"

    volumes:
      - $PWD/Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
      - web_static:/static:ro

    networks:
      - duckhunt

    restart: unless-stopped

    logging:
      options:
        max-size: "1m"
        max-file: "3"

  duckhunt_postgres:
    image: "postgres:12"

    container_name: duckhunt_postgres
    hostname: duckhunt_postgres

    environment:
      POSTGRES_USER: "duckhunt"
      POSTGRES_PASSWORD: "duckhunt"
      POSTGRES_DB: "duckhunt"
      POSTGRES_PORT: "5432"
      PGDATA: "/data/postgres"

    volumes:
      - postgres:/data/postgres

    ports:
      - "54320:5432"

    networks:
      - duckhunt

    restart: unless-stopped

    logging:
      options:
        max-size: "1m"
        max-file: "3"

  duckhunt_cache:
    image: "memcached"

    container_name: duckhunt_cache
    hostname: duckhunt_cache

    ports:
      - "11211:11211"

    entrypoint:
      - memcached
      - -m 64

    networks:
      - duckhunt

    restart: unless-stopped


volumes:
  caddy_data:
  caddy_config:
  postgres:
  duckhunt_cache:
  web_static:

networks:
  duckhunt:
